<form [formGroup]="form">
  @if (!hideHeader) {
    <div class="header full-width">
      <h3>Property</h3>
    </div>
  }

  <mat-form-field class="full-width" appearance="outline">
    <mat-label>Civic Address</mat-label>
    <textarea matInput formControlName="civicAddress" rows="1"></textarea>
  </mat-form-field>
  @if (form.get('civicAddress')?.hasError('required') && form.get('civicAddress')?.touched) {
    <div class="validation-error">
      <mat-icon class="error-icon">warning</mat-icon>
      <span>This field is required</span>
    </div>
  }

  <mat-form-field class="full-width" appearance="outline">
    <mat-label>Legal Description</mat-label>
    <textarea matInput formControlName="legalDescription" rows="1"></textarea>
  </mat-form-field>
  @if (form.get('legalDescription')?.hasError('required') && form.get('legalDescription')?.touched) {
    <div class="validation-error">
      <mat-icon class="error-icon">warning</mat-icon>
      <span>This field is required</span>
    </div>
  }

  <div class="government-region-fields">
    <div class="government-field">
      <mat-form-field appearance="outline">
        <mat-label>Local or First Nation Government*</mat-label>
        <input
          matInput
          type="text"
          [formControl]="localGovernmentControl"
          [matAutocomplete]="auto"
          placeholder="Type government name"
          (blur)="onLocalGovernmentBlur()"
          />
        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onLocalGovernmentChange($event)">
          @for (lg of filteredLocalGovernments | async; track lg) {
            <mat-option [value]="lg.uuid">
              {{ lg.name }}
            </mat-option>
          }
        </mat-autocomplete>
      </mat-form-field>
      @if (localGovernmentControl.hasError('required') && localGovernmentControl.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>This field is required</span>
        </div>
      }
    </div>

    <div class="region-field">
      <mat-form-field appearance="outline">
        <mat-label>Region</mat-label>
        <mat-select formControlName="regionCode">
          @for (region of regions; track region) {
            <mat-option [value]="region.code">
              {{ region.label }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
      @if (form.get('regionCode')?.hasError('required') && form.get('regionCode')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>This field is required</span>
        </div>
      }
    </div>
  </div>

  <div class="coordinate-fields">
    <div class="coordinate-field">
      <mat-form-field appearance="outline">
        <mat-label>Latitude</mat-label>
        <input type="text" matInput formControlName="latitude" placeholder="e.g. 49.55555" (blur)="onLatitudeBlur()" />
      </mat-form-field>
      @if (form.get('latitude')?.hasError('required') && form.get('latitude')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>This field is required</span>
        </div>
      }
      <div class="coordinate-help">Valid Range is 48 to 61. Must have exactly 5 decimal places (e.g. 49.55555). Integers like 49 will be formatted to 49.00000.</div>
      @if (form.get('latitude')?.hasError('min') && form.get('latitude')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>Latitude must be at least 48</span>
        </div>
      }
      @if (form.get('latitude')?.hasError('max') && form.get('latitude')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>Latitude must be at most 61</span>
        </div>
      }
      @if (form.get('latitude')?.hasError('decimalPlaces') && form.get('latitude')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>Latitude must have exactly 5 decimal places (e.g. 49.55555)</span>
        </div>
      }
    </div>

    <div class="coordinate-field">
      <mat-form-field appearance="outline">
        <mat-label>Longitude</mat-label>
        <input type="text" matInput formControlName="longitude" placeholder="e.g. -130.55555" (blur)="onLongitudeBlur()" />
      </mat-form-field>
      @if (form.get('longitude')?.hasError('required') && form.get('longitude')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>This field is required</span>
        </div>
      }
      <div class="coordinate-help">Valid Range is -140 to -113. Must have exactly 5 decimal places (e.g. -130.55555). Integers like -130 will be formatted to -130.00000.</div>
      @if (form.get('longitude')?.hasError('min') && form.get('longitude')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>Longitude must be at least -140</span>
        </div>
      }
      @if (form.get('longitude')?.hasError('max') && form.get('longitude')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>Longitude must be at most -113</span>
        </div>
      }
      @if (form.get('longitude')?.hasError('decimalPlaces') && form.get('longitude')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>Longitude must have exactly 5 decimal places (e.g. -130.55555)</span>
        </div>
      }
    </div>
  </div>

  <div class="ownership-type-section">
    <label class="ownership-type-label">Ownership Type</label>
    <mat-button-toggle-group formControlName="ownershipTypeCode" class="ownership-toggle-group">
      <mat-button-toggle value="SMPL">Fee Simple</mat-button-toggle>
      <mat-button-toggle value="CRWN">Crown</mat-button-toggle>
    </mat-button-toggle-group>
  </div>

  <div class="pid-pin-section">
    <div class="pid-pin-fields">
      <div class="pid-pin-selector">
        <mat-form-field appearance="outline">
          <mat-label>Select to Choose PID or PIN</mat-label>
          <mat-select formControlName="pidOrPin" (selectionChange)="onPidOrPinChange($event)">
            <mat-option value="PID">PID</mat-option>
            <mat-option value="PIN">PIN</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="input-field-container">
        @if (form.get('pidOrPin')?.value === 'PID') {
          <div class="pid-field">
            <mat-form-field appearance="outline">
              <mat-label>Enter PID</mat-label>
              <input matInput formControlName="pid" mask="000-000-000" placeholder="XXX-XXX-XXX" />
            </mat-form-field>
            @if (form.get('pid')?.hasError('required') && form.get('pid')?.touched) {
              <div class="validation-error">
                <mat-icon class="error-icon">warning</mat-icon>
                <span>This field is required</span>
              </div>
            }
            @if (form.get('pid')?.hasError('pidLength') && form.get('pid')?.touched) {
              <div class="validation-error">
                <mat-icon class="error-icon">warning</mat-icon>
                <span>PID must be exactly 9 digits</span>
              </div>
            }
          </div>
        }

        @if (form.get('pidOrPin')?.value === 'PIN') {
          <div class="pin-field">
            <mat-form-field appearance="outline">
              <mat-label>Enter PIN</mat-label>
              <input matInput formControlName="pin" />
            </mat-form-field>
            @if (form.get('pin')?.hasError('required') && form.get('pin')?.touched) {
              <div class="validation-error">
                <mat-icon class="error-icon">warning</mat-icon>
                <span>This field is required</span>
              </div>
            }
          </div>
        }
      </div>
    </div>
  </div>

  <div class="area-fields">
    <div class="area-field">
      <mat-form-field appearance="outline">
        <mat-label>Area (ha)</mat-label>
        <input type="number" matInput formControlName="areaHectares" step="0.01" min="0" placeholder="e.g. 10.50" />
      </mat-form-field>
      @if (form.get('areaHectares')?.hasError('required') && form.get('areaHectares')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>This field is required</span>
        </div>
      }
      @if (form.get('areaHectares')?.hasError('min') && form.get('areaHectares')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>Area must be at least 0</span>
        </div>
      }
    </div>

    <div class="alr-field">
      <mat-form-field appearance="outline">
        <mat-label>% within ALR</mat-label>
        <input type="number" matInput formControlName="alrPercentage" step="0.1" min="0" max="100" placeholder="e.g. 75.5" />
        <span matTextSuffix>%</span>
      </mat-form-field>
      @if (form.get('alrPercentage')?.hasError('required') && form.get('alrPercentage')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>This field is required</span>
        </div>
      }
      @if (form.get('alrPercentage')?.hasError('min') && form.get('alrPercentage')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>% within ALR must be at least 0</span>
        </div>
      }
      @if (form.get('alrPercentage')?.hasError('max') && form.get('alrPercentage')?.touched) {
        <div class="validation-error">
          <mat-icon class="error-icon">warning</mat-icon>
          <span>% within ALR must be at most 100</span>
        </div>
      }
    </div>
  </div>

  <mat-form-field class="full-width" appearance="outline">
    <mat-label>ALC History</mat-label>
    <textarea matInput formControlName="alcHistory" rows="4" placeholder="Enter ALC history details..."></textarea>
  </mat-form-field>
  @if (form.get('alcHistory')?.hasError('required') && form.get('alcHistory')?.touched) {
    <div class="validation-error">
      <mat-icon class="error-icon">warning</mat-icon>
      <span>This field is required</span>
    </div>
  }
</form>
