<section>
  <form class="content" [formGroup]="searchForm" (ngSubmit)="onSubmit()">
    <mat-form-field class="full-width" appearance="outline">
      <input
        placeholder="Search Inbox by File ID"
        mask="0*"
        id="fileNumber"
        matInput
        formControlName="fileNumber"
        aria-label="search"
        />
    </mat-form-field>

    @if (profile && profile.isBusiness) {
      <div>
        <mat-checkbox [formControl]="createdByMe">Only show created by me</mat-checkbox>
      </div>
    }

    <mat-expansion-panel #panel>
      <mat-expansion-panel-header class="search-toggle">
        <mat-panel-title>{{ panel.expanded ? 'Less' : 'More' }} Search Options</mat-panel-title>
      </mat-expansion-panel-header>
      <div class="search-form">
        @if (profile && (profile.isFirstNationGovernment || profile.isLocalGovernment)) {
          <div>
            <mat-label for="filterBy">Filter By</mat-label>
            <mat-form-field appearance="outline">
              <mat-select id="filterBy" [formControl]="filterBy">
                <mat-option value="created">Created By {{ profile.government }}</mat-option>
                <mat-option value="submitted">Submitted To {{ profile.government }}</mat-option>
              </mat-select>
              @if (filterBy.value) {
                <button
                  class="clear-button"
                  matSuffix
                  mat-icon-button
                  aria-label="Clear"
                  (click)="filterBy.reset()"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>
          </div>
        }
        @if (profile && (profile.isFirstNationGovernment || profile.isLocalGovernment)) {
          <div>
            <label for="governmentFileNumber">Local/First Nation Gov File Number</label>
            <mat-form-field appearance="outline">
              <input id="governmentFileNumber" matInput [formControl]="governmentFileNumber" />
              @if (governmentFileNumber.value) {
                <button
                  class="clear-button"
                  matSuffix
                  mat-icon-button
                  aria-label="Clear"
                  (click)="governmentFileNumber.reset()"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>
          </div>
        }
        <div>
          <label for="name">Name</label>
          <mat-form-field appearance="outline">
            <input id="name" matInput [formControl]="nameControl" minlength="3" />
            @if (nameControl.value) {
              <button
                class="clear-button"
                matSuffix
                mat-icon-button
                aria-label="Clear"
                (click)="nameControl.reset()"
                >
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>
          @if (nameControl.invalid && (nameControl.dirty || nameControl.touched)) {
            <div class="field-error">
              <mat-icon>warning</mat-icon>
              @if (nameControl.errors?.['minlength']) {
                <div>Enter 3 or more characters to search by name</div>
              }
            </div>
          }
        </div>
        <div>
          <label for="pid">PID</label>
          <mat-form-field appearance="outline">
            <input id="pid" matInput [formControl]="pidControl" minlength="9" maxlength="12" mask="000-000-000" />
            @if (pidControl.value) {
              <button
                class="clear-button"
                matSuffix
                mat-icon-button
                aria-label="Clear"
                (click)="pidControl.reset()"
                >
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>
          @if (pidInvalid) {
            <div class="field-error">
              <mat-icon>warning</mat-icon>
              @if (pidControl.errors?.['mask']) {
                <div>PID must be 9 digits including leading zeroes</div>
              }
            </div>
          }
        </div>
        <div
          [ngClass]="{
            'full-width': profile && (profile.isLocalGovernment || profile.isFirstNationGovernment)
          }"
          >
          <label for="civicAddress">Civic Address</label>
          <mat-form-field appearance="outline">
            <input id="civicAddress" matInput [formControl]="civicAddressControl" minlength="3" />
            @if (civicAddressControl.value) {
              <button
                class="clear-button"
                matSuffix
                mat-icon-button
                aria-label="Clear"
                (click)="civicAddressControl.reset()"
                >
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>
          @if (civicAddressInvalid) {
            <div class="field-error">
              <mat-icon>warning</mat-icon>
              @if (civicAddressControl.errors?.['minlength']) {
                <div>Enter 3 or more characters to search</div>
              }
            </div>
          }
        </div>
        <div>
          <label for="type">Type</label>
          <app-file-type-filter-drop-down
            #fileTypeDropDown
            [setFileTypes]="previousFileTypes"
            (fileTypeChange)="onFileTypeChange($event)"
            />
        </div>
        <div>
          <mat-label for="status">Status</mat-label>
          <mat-form-field appearance="outline">
            <mat-select [multiple]="true" id="status" [formControl]="portalStatusControl">
              @for (status of allStatuses; track status) {
                <mat-option [value]="status.code">
                  {{ status.label }}
                </mat-option>
              }
            </mat-select>
            @if (portalStatusControl.value?.length) {
              <button
                class="clear-button"
                matSuffix
                mat-icon-button
                aria-label="Clear"
                (click)="portalStatusControl.reset()"
                >
                <mat-icon>close</mat-icon>
              </button>
            }
          </mat-form-field>
        </div>
        @if (profile && !profile.isFirstNationGovernment && !profile.isLocalGovernment) {
          <div>
            <label for="governmentFileNumber">Local/First Nation Gov File Number</label>
            <mat-form-field appearance="outline">
              <input id="governmentFileNumber" matInput [formControl]="governmentFileNumber" />
              @if (governmentFileNumber.value) {
                <button
                  class="clear-button"
                  matSuffix
                  mat-icon-button
                  aria-label="Clear"
                  (click)="governmentFileNumber.reset()"
                  >
                  <mat-icon>close</mat-icon>
                </button>
              }
            </mat-form-field>
          </div>
        }
      </div>
    </mat-expansion-panel>

    <div class="button-controls">
      <button type="button" mat-stroked-button color="primary" (click)="onClear()">Clear</button>
      <button type="submit" mat-flat-button color="primary" [disabled]="!searchForm.valid">Search</button>
    </div>
  </form>

  <div class="search-fields-wrapper search-result-wrapper">
    @if (isLoading) {
      <div class="center">
        <mat-spinner></mat-spinner>
      </div>
    }
    @if (!isLoading) {
      <mat-tab-group
        [selectedIndex]="tabIndex"
        mat-align-tabs="start"
        mat-stretch-tabs
        #searchResultTabs
        >
        <mat-tab label="applications">
          <ng-template mat-tab-label> Applications: {{ applicationTotal }}</ng-template>
          @if (isMobile) {
            <app-inbox-list
              [items]="applications"
              [totalCount]="applicationTotal"
              (loadMore)="onLoadMore('APP')"
              type="Application"
              >
            </app-inbox-list>
          }
          @if (!isMobile) {
            <app-inbox-table
              [items]="applications"
              [totalCount]="applicationTotal"
              (tableChange)="onTableChange($event)"
              [pageIndex]="pageIndex"
              type="Application"
            ></app-inbox-table>
          }
        </mat-tab>
        <mat-tab label="notices-of-intent">
          <ng-template mat-tab-label> Notice of Intent: {{ noticeOfIntentTotal }}</ng-template>
          @if (isMobile) {
            <app-inbox-list
              [items]="noticeOfIntents"
              [totalCount]="noticeOfIntentTotal"
              (loadMore)="onLoadMore('NOI')"
              type="Notice of Intent"
              >
            </app-inbox-list>
          }
          @if (!isMobile) {
            <app-inbox-table
              [items]="noticeOfIntents"
              [totalCount]="noticeOfIntentTotal"
              (tableChange)="onTableChange($event)"
              type="Notice of Intent"
            ></app-inbox-table>
          }
        </mat-tab>
        <mat-tab label="notifications">
          <ng-template mat-tab-label> Notification of SRW: {{ notificationTotal }}</ng-template>
          @if (isMobile) {
            <app-inbox-list
              [items]="notifications"
              [totalCount]="notificationTotal"
              (loadMore)="onLoadMore('NOTI')"
              type="Notification"
              >
            </app-inbox-list>
          }
          @if (!isMobile) {
            <app-inbox-table
              [items]="notifications"
              type="Notification"
              [totalCount]="notificationTotal"
              (tableChange)="onTableChange($event)"
              >
            </app-inbox-table>
          }
        </mat-tab>
      </mat-tab-group>
    }
  </div>
</section>
