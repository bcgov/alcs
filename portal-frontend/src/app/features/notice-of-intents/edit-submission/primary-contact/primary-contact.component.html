<section>
  <div class="step-description">
    <h2>Primary Contact</h2>
    <p>
      The primary contact becomes the single point of contact and must ensure that landowners are notified of all
      information exchanged between the primary contact, local or First Nation government, and the ALC.
    </p>
    <p>*All fields are required unless stated optional or disabled.</p>
  </div>
</section>

<section>
  <div class="agent-form">
    <form [formGroup]="form">
      <div class="form-row">
        <div class="full-row">
          @if (isGovernmentUser) {
            <p>
              <strong
                >Will {{ governmentName ?? 'Local / First Nation Government' }} staff be the primary contact?</strong
                >
              </p>
            }
            @if (!isGovernmentUser) {
              <p>
                <strong
                  >Will one of the landowners
                  @if (hasCrownParcels) {
                    or government contacts
                    } added previously be the
                    primary contact?</strong
                    >
                  </p>
                }

                <mat-button-toggle-group
                  class="input"
                  [value]="!selectedThirdPartyAgent"
                  (change)="onSelectPrimaryContactType($event)"
                  >
                  <mat-button-toggle [value]="true">Yes</mat-button-toggle>
                  <mat-button-toggle [value]="false">No</mat-button-toggle>
                </mat-button-toggle-group>
              </div>
            </div>

            <!-- Existing owner -->
            @if (!selectedThirdPartyAgent && !selectedLocalGovernment) {
              <div class="form-row">
                <div class="full-row">
                  @if (parcelOwners.length > 0) {
                    <label
                      >Select a Primary Contact from the listed land owners
                      @if (hasCrownParcels) {
                        and government contacts
                        }</label
                        >
                        <mat-radio-group
                          [formControl]="ownersList"
                          color="primary"
                          (change)="onSelectOwner($event.value)"
                          required
                          [ngClass]="{ error: ownersList.invalid && (ownersList.dirty || ownersList.touched) }"
                          >
                          @for (owner of parcelOwners; track owner) {
                            <mat-radio-button [value]="owner.uuid" class="radio-option" required>
                              {{ owner.firstName }} {{ owner.lastName }}
                            </mat-radio-button>
                          }
                        </mat-radio-group>
                        @if (ownersList.invalid && (ownersList.dirty || ownersList.touched)) {
                          <div class="field-error">
                            <mat-icon>warning</mat-icon>
                            @if (ownersList.errors?.['required']) {
                              <div>This field is required</div>
                            }
                          </div>
                        }
                        @if (selectedOwnerUuid && selectedOwnerUuid !== 'agent' && !selectedLocalGovernment) {
                          <div
                            id="owner-info"
                            class="warning-banner"
                            >
                            <div class="owner-details">
                              <div class="row">
                                <div class="key"><strong>First Name:</strong></div>
                                <div class="value">{{ firstName.value }}</div>
                              </div>
                              <div class="row">
                                <div class="key"><strong>Last Name:</strong></div>
                                <div class="value">{{ lastName.value }}</div>
                              </div>
                              @if (organizationName.value) {
                                <div class="row">
                                  @if (!isCrownOwner && !isGovernmentUser) {
                                    <div class="key"><strong>Organization:</strong></div>
                                  }
                                  @if (isCrownOwner) {
                                    <div class="key"><strong>Ministry/Department:</strong></div>
                                  }
                                  <div class="value">{{ organizationName.value }}</div>
                                </div>
                              }
                              <div class="row">
                                <div class="key"><strong>Phone Number:</strong></div>
                                <div class="value">{{ phoneNumber.value ?? '' | mask: '(000) 000-0000' }}</div>
                              </div>
                              <div class="row">
                                <div class="key"><strong>Email:</strong></div>
                                <div class="value">{{ email.value }}</div>
                              </div>
                              <div class="row">
                                <button mat-flat-button (click)="onEdit(selectedOwnerUuid)">Edit information</button>
                              </div>
                            </div>
                          </div>
                        }
                      }
                      @if (parcelOwners.length === 0 && !isGovernmentUser && !selectedThirdPartyAgent) {
                        <app-warning-banner>
                          No landowners or government contacts are added. Please go back to Step 1 to add information.
                        </app-warning-banner>
                      }
                    </div>
                  </div>
                }
                <!-- /Existing owner -->

                <!-- Third-Part Agent/Government -->
                @if (selectedThirdPartyAgent || selectedLocalGovernment) {
                  <div class="form-row">
                    <div class="full-row">
                      @if (selectedThirdPartyAgent) {
                        <h3>Agent Contact Information</h3>
                      }
                      @if (selectedLocalGovernment) {
                        <h3>
                          {{ governmentName ?? 'Local / First Nation Government' }} Staff Contact Information
                        </h3>
                      }
                    </div>
                    <div>
                      <label for="firstName">First Name</label>
                      <mat-form-field appearance="outline">
                        <input id="firstName" matInput placeholder="Enter First Name" formControlName="firstName" />
                      </mat-form-field>
                      @if (firstName.invalid && (firstName.dirty || firstName.touched)) {
                        <div class="field-error">
                          <mat-icon>warning</mat-icon>
                          @if (firstName.errors?.['required']) {
                            <div>This field is required</div>
                          }
                        </div>
                      }
                    </div>
                    <div>
                      <label for="lastName">Last Name</label>
                      <mat-form-field appearance="outline">
                        <input id="lastName" matInput placeholder="Enter Last Name" formControlName="lastName" />
                      </mat-form-field>
                      @if (lastName.invalid && (lastName.dirty || lastName.touched)) {
                        <div class="field-error">
                          <mat-icon>warning</mat-icon>
                          @if (lastName.errors?.['required']) {
                            <div>This field is required</div>
                          }
                        </div>
                      }
                    </div>
                    <div class="full-row">
                      @if (!selectedLocalGovernment) {
                        <label for="orgName">Organization Name (optional)</label>
                      }
                      @if (selectedLocalGovernment) {
                        <label for="orgName">Department</label>
                      }
                      <mat-form-field appearance="outline">
                        @if (!selectedLocalGovernment) {
                          <input
                            id="orgName"
                            matInput
                            placeholder="Enter Organization Name"
                            formControlName="organizationName"
                            />
                        }
                        @if (selectedLocalGovernment) {
                          <input
                            id="orgName"
                            matInput
                            placeholder="Enter Department Name"
                            formControlName="organizationName"
                            />
                        }
                      </mat-form-field>
                      @if (organizationName.invalid && (organizationName.dirty || organizationName.touched)) {
                        <div
                          class="field-error"
                          >
                          <mat-icon>warning</mat-icon>
                          @if (organizationName.errors?.['required']) {
                            <div>This field is required</div>
                          }
                        </div>
                      }
                    </div>
                    <div>
                      <label for="phoneNumber">Phone Number</label>
                      <mat-form-field appearance="outline">
                        <input
                          id="phoneNumber"
                          mask="(000) 000-0000"
                          matInput
                          maxlength="14"
                          placeholder="(555) 555-5555"
                          formControlName="phoneNumber"
                          />
                      </mat-form-field>
                      @if (phoneNumber.invalid && (phoneNumber.dirty || phoneNumber.touched)) {
                        <div class="field-error">
                          <mat-icon>warning</mat-icon>
                          @if (phoneNumber.errors?.['required']) {
                            <div>This field is required</div>
                          }
                          @if (phoneNumber.errors?.['mask']) {
                            <div>Invalid format</div>
                          }
                        </div>
                      }
                    </div>
                    <div>
                      <label for="email">Email</label>
                      <mat-form-field appearance="outline">
                        <input id="email" type="email" matInput placeholder="Enter Email" formControlName="email" />
                      </mat-form-field>
                      @if (email.invalid && (email.dirty || email.touched)) {
                        <div class="field-error">
                          <mat-icon>warning</mat-icon>
                          @if (email.errors?.['required']) {
                            <div>This field is required</div>
                          }
                          @if (email.errors?.['email']) {
                            <div>Invalid format</div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }
                <!-- /Third-Part Agent/Government -->

                @if (needsAuthorizationLetter || hasCrownParcels || files.length > 0) {
                  <div class="form-row">
                    <div class="full-row">
                      <label for="authorization-letter" class="subheading2">Authorization Letters</label>
                      <p class="subtext">
                        For privately owned Fee Simple parcels, the letter must be signed by all individual landowners and the
                        majority of directors within the organization. For Crown parcels or Fee Simple parcels owned by a
                        government, the letter must be signed by senior level staff.
                      </p>
                      <app-info-banner>
                        Visit the
                        <a
                          href="https://www.alc.gov.bc.ca/application-and-notice-process/soil-and-fill-notice-of-intent/#noi-documents"
                          target="_blank"
                          >ALC website</a
                          >
                          for a template.
                        </app-info-banner>
                        <div class="uploader">
                          <app-file-drag-drop
                            id="authorization-letter"
                            [allowMultiple]="true"
                            [uploadedFiles]="files"
                            (uploadFiles)="attachAuthorizationLetter($event)"
                            (deleteFile)="onDeleteFile($event)"
                            [showErrors]="showErrors"
                            [isRequired]="needsAuthorizationLetter"
                            [showHasVirusError]="showHasVirusError"
                            [showVirusScanFailedError]="showVirusScanFailedError"
                          ></app-file-drag-drop>
                        </div>
                      </div>
                    </div>
                  }
                </form>
              </div>
            </section>

            <div class="button-container">
              @if (!draftMode) {
                <button (click)="onSaveExit()" mat-stroked-button color="accent">Save and Exit</button>
              }
              @if (draftMode) {
                <button (click)="onSaveExit()" mat-stroked-button color="accent">Discard all Changes</button>
              }
              <div>
                <button mat-stroked-button color="primary" (click)="onNavigateToStep(currentStep - 1)">
                  Previous<span class="mobile-hidden"> Step</span>
                </button>
                <button mat-flat-button color="primary" (click)="onNavigateToStep(currentStep + 1)">
                  Next<span class="mobile-hidden"> Step</span>
                </button>
              </div>
            </div>
